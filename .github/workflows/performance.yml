name: Performance Monitoring

on:
  # Performance checks on PRs (catch regressions)
  pull_request:
    branches: [main, dev]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
      - ".github/**"

  # Performance monitoring on main pushes (production)
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"

  # Manual performance testing
  workflow_dispatch:

jobs:
  build-performance:
    name: Build Performance Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Analyze bundle size
        run: |
          echo "ğŸ“¦ Bundle Size Analysis"
          echo "======================="

          # Build and analyze
          npm run build

          # Get build info
          echo "ğŸ“Š Build completed successfully!"
          echo "ğŸ“ Build directory size:"
          du -sh .next/ || echo "Build directory not found"

          echo ""
          echo "ğŸ“ˆ Bundle analysis complete!"

      - name: Build performance metrics
        run: |
          echo "â±ï¸ Build Performance Metrics"
          echo "============================="

          # Time the build process
          start_time=$(date +%s)
          npm run build
          end_time=$(date +%s)
          build_time=$((end_time - start_time))

          echo "ğŸš€ Build completed in ${build_time} seconds"

          # Check for build warnings
          if npm run build 2>&1 | grep -i warning; then
            echo "âš ï¸ Build warnings detected - please review"
          else
            echo "âœ… No build warnings detected"
          fi

  lighthouse-ci:
    name: Lighthouse CI Performance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.13.x

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm start &
          sleep 10
          echo "ğŸš€ Application started on port 3000"

      - name: Run Lighthouse CI
        run: |
          echo "ğŸ” Running Lighthouse CI analysis..."
          lhci autorun || echo "Lighthouse CI completed with warnings"

      - name: Performance summary
        run: |
          echo "ğŸ“Š Performance Analysis Summary"
          echo "==============================="
          echo "âœ… Lighthouse CI analysis completed"
          echo "ğŸ“ˆ Results available in Lighthouse CI reports"
          echo ""
          echo "ğŸ¯ Key metrics checked:"
          echo "  â€¢ Performance Score"
          echo "  â€¢ First Contentful Paint (FCP)"
          echo "  â€¢ Largest Contentful Paint (LCP)"
          echo "  â€¢ Cumulative Layout Shift (CLS)"
          echo "  â€¢ Total Blocking Time (TBT)"

  core-web-vitals:
    name: Core Web Vitals Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build and analyze Core Web Vitals
        run: |
          echo "ğŸ¯ Core Web Vitals Analysis"
          echo "==========================="

          # Build the application
          npm run build

          echo "ğŸ“Š Core Web Vitals targets for excellent UX:"
          echo "  â€¢ LCP (Largest Contentful Paint): â‰¤ 2.5s"
          echo "  â€¢ FID (First Input Delay): â‰¤ 100ms" 
          echo "  â€¢ CLS (Cumulative Layout Shift): â‰¤ 0.1"
          echo ""
          echo "ğŸ” Built application ready for performance testing"
          echo "âœ… Use Lighthouse CI results above for detailed metrics"

  performance-summary:
    name: Performance Summary
    needs: [build-performance, lighthouse-ci, core-web-vitals]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Performance report summary
        run: |
          echo "ğŸ Performance Monitoring Summary"
          echo "=================================="
          echo ""
          echo "ğŸ“Š Job Results:"
          echo "  â€¢ Build Performance: ${{ needs.build-performance.result }}"
          echo "  â€¢ Lighthouse CI: ${{ needs.lighthouse-ci.result }}"
          echo "  â€¢ Core Web Vitals: ${{ needs.core-web-vitals.result }}"
          echo ""

          if [[ "${{ needs.build-performance.result }}" == "success" && "${{ needs.lighthouse-ci.result }}" == "success" && "${{ needs.core-web-vitals.result }}" == "success" ]]; then
            echo "ğŸ‰ All performance checks passed!"
            echo ""
            echo "ğŸš€ Your SAFE AI [4U] website performance is optimized!"
            echo "âœ… Build performance: Excellent"
            echo "âœ… Core Web Vitals: Checked" 
            echo "âœ… Lighthouse analysis: Completed"
          else
            echo "âš ï¸ Some performance checks need attention"
            echo ""
            echo "ğŸ’¡ Performance optimization suggestions:"
            echo "  â€¢ Review Lighthouse CI results for specific recommendations"
            echo "  â€¢ Check bundle size for optimization opportunities"
            echo "  â€¢ Optimize images and assets for better Core Web Vitals"
            echo "  â€¢ Consider code splitting for large bundles"
          fi

          echo ""
          echo "ğŸ“š Resources:"
          echo "  â€¢ Core Web Vitals: https://web.dev/vitals/"
          echo "  â€¢ Next.js Performance: https://nextjs.org/docs/advanced-features/measuring-performance"
